<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TheRoadApp - Bus & Hazard Tracker</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary-color:#007BFF; --bg-color:#121212; --surface-color:#1e1e1e; --surface-color-2:#2a2a2a;
      --text-color:#f0f0f0; --text-muted:#aaa; --border-color:#444; --border-radius:12px;
      --spacing-md:16px; --transition-speed:0.25s ease;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Space Grotesk',sans-serif;background:var(--bg-color);color:var(--text-color);-webkit-font-smoothing:antialiased}

    .container{max-width:1200px;margin:0 auto;padding:var(--spacing-md)}
    .main-header{margin-bottom:var(--spacing-md)}

    .tabs-nav{display:flex;background:var(--surface-color);border-radius:var(--border-radius);overflow:hidden;margin-bottom:var(--spacing-md)}
    .tab{flex:1;padding:12px;text-align:center;cursor:pointer;font-weight:600;border-bottom:3px solid transparent}
    .tab:hover{background:var(--surface-color-2)}
    .tab.active{color:var(--primary-color);border-bottom-color:var(--primary-color)}

    .section{display:none}
    .section.active{display:block}

    .search-form{display:grid;grid-template-columns:1fr 1fr auto;gap:12px;margin-bottom:12px}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border-color);background:var(--surface-color-2);color:var(--text-color)}

    .btn{padding:10px 14px;border-radius:10px;border:none;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--primary-color);color:#fff}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-secondary{background:var(--border-color);color:#fff}

    .map-wrapper{position:relative;height:75vh;border-radius:var(--border-radius);overflow:hidden}
    #map{height:100%;width:100%}

    .map-controls{position:absolute;top:12px;right:12px;z-index:1000;display:flex;flex-direction:column;gap:8px}
    .map-control-btn{background:rgba(30,30,30,0.9);border:1px solid var(--border-color);color:var(--text-color);width:40px;height:40px;border-radius:8px;display:grid;place-items:center;cursor:pointer}
    .theme-select{padding:8px;border-radius:8px;background:rgba(30,30,30,0.9);border:1px solid var(--border-color);color:var(--text-color)}

    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;z-index:2000;transition:opacity var(--transition-speed),visibility var(--transition-speed)}
    .modal-overlay.visible{opacity:1;visibility:visible}
    .modal{background:var(--surface-color);padding:18px;border-radius:12px;width:92%;max-width:480px}
    .modal-actions{display:flex;justify-content:flex-end;gap:12px;margin-top:12px}

    .bus-card{background:var(--surface-color);padding:12px;border-radius:12px;margin-top:12px;display:flex;justify-content:space-between;align-items:center;border-left:5px solid var(--primary-color)}

    @media (max-width:768px){.search-form{grid-template-columns:1fr}.map-control-btn{width:36px;height:36px}}
  </style>
</head>

<body>
  <main class="container">
    <header class="main-header"><h2>üöç TheRoadApp</h2></header>

    <nav class="tabs-nav">
      <div class="tab active" data-target="home">HOME</div>
      <div class="tab" data-target="map-section">MAP</div>
    </nav>

    <section id="home" class="section active">
      <p>Track live bus locations and report road hazards in your area.</p>
      <form class="search-form" onsubmit="return false;">
        <input id="from" type="text" placeholder="Departure Location" aria-label="Departure Location">
        <input id="to" type="text" placeholder="Destination" aria-label="Destination">
        <button id="search-btn" class="btn btn-primary">Search</button>
      </form>

      <div id="bus-results"></div>
      <button id="report-btn" class="btn btn-danger" style="margin-top:18px;width:100%">‚ö†Ô∏è Report Hazard</button>
    </section>

    <section id="map-section" class="section">
      <div class="map-wrapper">
        <div id="map"></div>

        <div class="map-controls">
          <select id="theme-select" class="theme-select" title="Map theme">
            <option value="default">üåç Default</option>
            <option value="dark">üåë Dark</option>
            <option value="light">‚òÄÔ∏è Light</option>
            <option value="satellite">üõ∞Ô∏è Satellite</option>
          </select>

          <button id="fullscreen-btn" class="map-control-btn" title="Toggle fullscreen">‚õ∂</button>
          <button id="zen-mode-btn" class="map-control-btn" title="Zen mode">üëÅ</button>
        </div>
      </div>
    </section>
  </main>

  <div id="modal" class="modal-overlay">
    <div class="modal">
      <h3>Report a New Hazard</h3>
      <form id="hazard-form" onsubmit="return false;">
        <div class="modal-content">
          <select id="hz-type" aria-label="Hazard Type">
            <option value="pothole">Pothole</option>
            <option value="obstruction">Obstruction</option>
            <option value="flood">Flooding</option>
            <option value="accident">Accident</option>
          </select>
          <textarea id="hz-desc" placeholder="Describe the hazard..." rows="3" aria-label="Hazard Description"></textarea>
          <input id="hz-photo" type="file" accept="image/*" capture="environment" aria-label="Upload Photo">
          <input id="hz-loc" placeholder="Your Location" readonly aria-label="Your Location">
        </div>
        <div class="modal-actions">
          <button id="cancel-hz" type="button" class="btn btn-secondary">Cancel</button>
          <button id="submit-hz" type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // CONFIG
    const SUPABASE_URL = "https://jnjhkmlvfmynxyjypyie.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuamhrbWx2Zm15bnh5anlweWllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNTA4MjMsImV4cCI6MjA3MzgyNjgyM30.Xp1Y3UvqQhbuxP3KV_1dtW8Zff-yy0fA94G5O3wecOo";
    const BUS_REFRESH_INTERVAL = 10000;

    // STATE
    let map = null;
    let busLayer = null;
    let roadHealthLayer = null;
    let mapInitialized = false;
    let refreshIntervalId = null;
    let currentBaseLayerKey = 'default';

    // ICON
    const busIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/61/61212.png',
      iconSize: [34, 34],
      iconAnchor: [17, 17],
      popupAnchor: [0, -18]
    });

    // DOM
    const UI = {
      tabs: document.querySelectorAll('.tab'),
      sections: document.querySelectorAll('.section'),
      searchBtn: document.getElementById('search-btn'),
      fromInput: document.getElementById('from'),
      toInput: document.getElementById('to'),
      busResults: document.getElementById('bus-results'),
      reportBtn: document.getElementById('report-btn'),
      fullscreenBtn: document.getElementById('fullscreen-btn'),
      zenModeBtn: document.getElementById('zen-mode-btn'),
      modalOverlay: document.getElementById('modal'),
      hazardForm: document.getElementById('hazard-form'),
      cancelHzBtn: document.getElementById('cancel-hz'),
      submitHzBtn: document.getElementById('submit-hz'),
      hzType: document.getElementById('hz-type'),
      hzDesc: document.getElementById('hz-desc'),
      hzPhoto: document.getElementById('hz-photo'),
      hzLoc: document.getElementById('hz-loc'),
      themeSelect: document.getElementById('theme-select')
    };

    document.addEventListener('DOMContentLoaded', () => setupEventListeners());

    function setupEventListeners(){
      UI.tabs.forEach(tab => tab.addEventListener('click', () => handleTabSwitch(tab)));
      UI.searchBtn.addEventListener('click', (e) => { e.preventDefault(); handleSearch(); });
      UI.reportBtn.addEventListener('click', openHazardModal);
      UI.cancelHzBtn.addEventListener('click', closeHazardModal);
      UI.hazardForm.addEventListener('submit', (e) => { e.preventDefault(); handleHazardSubmit(); });
      UI.fullscreenBtn.addEventListener('click', toggleFullScreen);
      UI.zenModeBtn.addEventListener('click', toggleZenMode);
      UI.themeSelect.addEventListener('change', (e) => setBaseLayer(e.target.value));
    }

    function handleTabSwitch(clickedTab){
      const activeTab = document.querySelector('.tab.active');
      const activeSection = document.querySelector('.section.active');
      if(activeTab) activeTab.classList.remove('active');
      if(activeSection) activeSection.classList.remove('active');

      clickedTab.classList.add('active');
      const targetId = clickedTab.dataset.target;
      const targetSection = document.getElementById(targetId);
      if(targetSection) targetSection.classList.add('active');

      if(targetId === 'map-section' && !mapInitialized) initMap();
      if(targetId === 'map-section' && map) setTimeout(()=>{ try{ map.invalidateSize(); } catch(e){} }, 250);
    }

    function handleSearch(){
      const from = UI.fromInput.value || 'City A';
      const to = UI.toInput.value || 'City B';
      UI.busResults.innerHTML = '';

      const example = [{id:'bus101'}, {id:'bus202'}];
      example.forEach(bus => {
        const card = document.createElement('div');
        card.className = 'bus-card';
        card.innerHTML = `<span><b>${bus.id}</b>: ${from} ‚Üí ${to}</span><button class="btn btn-primary">Track on Map</button>`;
        card.querySelector('button').addEventListener('click', () => {
          document.querySelector('.tab[data-target="map-section"]').click();
        });
        UI.busResults.appendChild(card);
      });
    }

    // MAP THEMES / TILE LAYERS
    const baseLayers = {
      default: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }),
      dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO & OpenStreetMap' }),
      light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO & OpenStreetMap' }),
      satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' })
    };

    function initMap(){
      mapInitialized = true;
      try{
        map = L.map('map', { center:[20.5937,78.9629], zoom:5, layers:[baseLayers[currentBaseLayerKey]] });

        // Create overlay groups
        busLayer = L.layerGroup().addTo(map);
        roadHealthLayer = L.layerGroup().addTo(map);

        // Add layer control (allows user to toggle base & overlays)
        const baseMapsForControl = {
          'üåç Default': baseLayers.default,
          'üåë Dark': baseLayers.dark,
          '‚òÄÔ∏è Light': baseLayers.light,
          'üõ∞ Satellite': baseLayers.satellite
        };
        const overlayMaps = {
          'üöç Live Buses': busLayer,
          'üõ£ Road Health': roadHealthLayer
        };

        L.control.layers(baseMapsForControl, overlayMaps, { position:'topleft', collapsed:false }).addTo(map);

        // Initial data
        loadBuses();
        fetchRoadHealth();

        if(refreshIntervalId) clearInterval(refreshIntervalId);
        refreshIntervalId = setInterval(()=>{ if(mapInitialized) loadBuses(); }, BUS_REFRESH_INTERVAL);

        // React to zoom/resize after render
        setTimeout(()=>{ try{ map.invalidateSize(); } catch(e){} }, 300);

      } catch(err){ console.error('initMap error',err); }
    }

    function setBaseLayer(key){
      if(!map || !baseLayers[key]) return;
      try{
        const newLayer = baseLayers[key];
        const currentLayer = baseLayers[currentBaseLayerKey];
        if(currentLayer && map.hasLayer(currentLayer)) map.removeLayer(currentLayer);
        map.addLayer(newLayer);
        currentBaseLayerKey = key;
      }catch(e){ console.warn('setBaseLayer error', e); }
    }

    function toggleFullScreen(){
      const mapContainer = document.getElementById('map-section');
      if(!mapContainer) return;
      if(!document.fullscreenElement){ mapContainer.requestFullscreen?.().catch(()=>{}); }
      else document.exitFullscreen?.();
      setTimeout(()=>{ if(map) try{ map.invalidateSize(); }catch(e){} }, 300);
    }

    function toggleZenMode(){ document.body.classList.toggle('zen-mode'); setTimeout(()=>{ if(map) try{ map.invalidateSize(); }catch(e){} }, 300); }

    // API helper
    async function apiFetch(endpoint, options={}){
      const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
      const headers = { apikey: SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}`, 'Content-Type':'application/json', ...(options.headers||{}) };
      const resp = await fetch(url, {...options, headers});
      let data;
      const text = await resp.text();
      try{ data = text ? JSON.parse(text) : null; } catch(e){ data = text; }
      if(!resp.ok){ const msg = (data && data.message) ? data.message : `API error ${resp.status}`; throw new Error(msg); }
      return data;
    }

    // Load buses and render markers using busIcon
    async function loadBuses(){
      if(!busLayer) return;
      try{
        const rows = await apiFetch('bus_location?select=*&order=ts.desc&limit=500');
        if(!Array.isArray(rows)) return;

        // get latest per device
        const latest = {};
        for(const r of rows){ if(!r || !r.device_id) continue; if(!latest[r.device_id]) latest[r.device_id] = r; }

        busLayer.clearLayers();
        const bounds = [];
        for(const r of Object.values(latest)){
          const lat = parseFloat(r.lat ?? r.latitude ?? r.lat_start);
          const lon = parseFloat(r.lon ?? r.longitude ?? r.lon_start);
          if(Number.isFinite(lat) && Number.isFinite(lon)){
            const marker = L.marker([lat, lon], { icon:busIcon }).addTo(busLayer).bindPopup(`<b>Bus ID:</b> ${escapeHtml(String(r.device_id))}`);
            bounds.push([lat, lon]);
          }
        }

        if(bounds.length===1) map.setView(bounds[0],13);
        else if(bounds.length>1) try{ map.fitBounds(bounds, { padding:[40,40], maxZoom:13 }); } catch(e){}

      }catch(err){ console.error('loadBuses error', err); }
    }

    // Road health lines
    async function fetchRoadHealth(){
      if(!roadHealthLayer) return;
      try{
        const rows = await apiFetch('road_health?select=*');
        if(!Array.isArray(rows)) return;
        roadHealthLayer.clearLayers();
        for(const r of rows){
          const lat1 = parseFloat(r.lat_start ?? r.lat1 ?? r.lat);
          const lon1 = parseFloat(r.lon_start ?? r.lon1 ?? r.lon);
          const lat2 = parseFloat(r.lat_end ?? r.lat2 ?? r.lat);
          const lon2 = parseFloat(r.lon_end ?? r.lon2 ?? r.lon);
          if([lat1,lon1,lat2,lon2].some(v => !Number.isFinite(v))) continue;
          const color = (r.score==='bad') ? 'red' : (r.score==='medium') ? 'orange' : 'green';
          L.polyline([[lat1,lon1],[lat2,lon2]], { color, weight:5, opacity:0.85 }).addTo(roadHealthLayer);
        }
      }catch(err){ console.error('fetchRoadHealth error', err); }
    }

    // HAZARD modal
    function openHazardModal(){
      if(!UI.modalOverlay) return;
      UI.modalOverlay.classList.add('visible');
      if(UI.hzLoc) UI.hzLoc.value = 'Locating...';

      if(!navigator.geolocation) { if(UI.hzLoc) UI.hzLoc.value = 'Geolocation not supported'; return; }

      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude; const lon = pos.coords.longitude;
        if(UI.hzLoc) UI.hzLoc.value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
        UI.modalOverlay.dataset.lat = lat; UI.modalOverlay.dataset.lon = lon;
      }, err => { if(UI.hzLoc) UI.hzLoc.value = 'Could not get location.'; }, { enableHighAccuracy:true, timeout:8000 });
    }

    function closeHazardModal(){ if(!UI.modalOverlay) return; UI.modalOverlay.classList.remove('visible'); UI.hazardForm.reset(); delete UI.modalOverlay.dataset.lat; delete UI.modalOverlay.dataset.lon; }

    async function handleHazardSubmit(){
      const lat = parseFloat(UI.modalOverlay.dataset.lat); const lon = parseFloat(UI.modalOverlay.dataset.lon);
      if(!Number.isFinite(lat) || !Number.isFinite(lon)) { alert('Location is required to submit a hazard report.'); return; }
      setSubmitButtonState(true,'Submitting...');
      try{
        const photoFile = UI.hzPhoto.files && UI.hzPhoto.files[0] ? UI.hzPhoto.files[0] : null;
        const photo_data = photoFile ? await fileToBase64(photoFile) : null;
        const payload = { type: UI.hzType.value, description: UI.hzDesc.value, lat, lon, photo_data, created_at: new Date().toISOString() };
        await apiFetch('hazards', { method:'POST', body: JSON.stringify(payload) });
        alert('Hazard submitted successfully!');
        closeHazardModal();
      }catch(err){ console.error('hazard submit err',err); alert('Error submitting hazard: '+(err && err.message?err.message:err)); }
      finally{ setSubmitButtonState(false,'Submit'); }
    }

    function setSubmitButtonState(disabled, text){ if(!UI.submitHzBtn) return; UI.submitHzBtn.disabled = disabled; UI.submitHzBtn.textContent = text; }

    function fileToBase64(file){ return new Promise((res,rej)=>{ const reader=new FileReader(); reader.onload=()=>res(reader.result); reader.onerror=err=>rej(err); reader.readAsDataURL(file); }); }

    function escapeHtml(str){ return str.replace(/[&<>"'`]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;",'`':'&#96;'}[s])); }

    // Clean up
    window.addEventListener('beforeunload', ()=>{ if(refreshIntervalId) clearInterval(refreshIntervalId); });

  </script>
</body>

</html>
