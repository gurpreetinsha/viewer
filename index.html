<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>BusTracker — Demo Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body{margin:0;font-family:Inter,system-ui,Arial, sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#0b5ed7;color:white}
    header button{background:rgba(255,255,255,0.15);border:none;color:white;padding:6px 10px;border-radius:6px}
    #container{display:flex;flex-direction:column;height:calc(100vh - 52px)}
    #tabs{display:flex;gap:12px;padding:10px;background:#f4f6fb}
    #tabs button{padding:8px 12px;border-radius:6px;border:1px solid #ddd;background:white}
    #main{flex:1;display:flex}
    #left{width:360px;border-right:1px solid #eee;padding:12px;overflow:auto}
    #right{flex:1;position:relative}
    #map{height:100%;width:100%}
    .input{width:100%;padding:8px;margin-bottom:8px;border-radius:6px;border:1px solid #ccc}
    .route-card{border:1px solid #ddd;padding:8px;border-radius:6px;margin-bottom:8px}
    .small{font-size:13px;color:#555}
    #complaintForm{margin-top:12px;padding:10px;border:1px dashed #ddd;border-radius:6px}
    .layer-toggle{display:flex;gap:6px;align-items:center;margin-bottom:8px}
  </style>
</head>
<body>
  <header>
    <div><strong>BusTracker Demo</strong> — HOME & MAPS</div>
    <div id="authArea">
      <button id="signupBtn">Sign Up</button>
      <button id="loginBtn">Login</button>
      <button id="logoutBtn" style="display:none">Logout</button>
      <span id="userEmail" style="margin-left:8px;color:#fff;font-weight:600"></span>
    </div>
  </header>

  <div id="container">
    <div id="tabs">
      <button onclick="showTab('home')">HOME</button>
      <button onclick="showTab('maps')">MAPS</button>
    </div>

    <div id="main">
      <div id="left">
        <!-- HOME panel -->
        <div id="homePanel">
          <h3>Find Buses</h3>
          <input id="from" class="input" placeholder="From (village/city/station)"/>
          <input id="to" class="input" placeholder="To (village/city/station)"/>
          <button onclick="searchRoutes()" style="padding:8px 12px;border-radius:6px">Find buses</button>
          <hr>
          <div id="routesList"></div>
        </div>

        <!-- Complain + other actions -->
        <div id="complaintWrap" style="margin-top:18px">
          <h4>Report road issue (login required)</h4>
          <div id="complaintForm">
            <div class="small">Photo (camera):</div>
            <input id="photoInput" type="file" accept="image/*" capture="environment"><br>
            <div class="small">Message:</div>
            <textarea id="complaintMsg" rows="3" style="width:100%"></textarea>
            <button onclick="submitComplaint()" style="margin-top:8px;padding:8px 12px;border-radius:6px">Submit Complaint</button>
            <div id="complaintStatus" class="small" style="margin-top:6px"></div>
          </div>
        </div>
      </div>

      <div id="right">
        <div style="position:absolute;z-index:999;right:12px;top:12px;background:white;padding:8px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.15)">
          <div class="layer-toggle"><input id="toggleBuses" type="checkbox" checked onchange="toggleLayer('buses')"><label for="toggleBuses">Show buses</label></div>
          <div class="layer-toggle"><input id="toggleRoads" type="checkbox" checked onchange="toggleLayer('roads')"><label for="toggleRoads">Road health</label></div>
        </div>
        <div id="map"></div>
      </div>
    </div>
  </div>

<script>
/* ========== CONFIG ========== */
const SUPABASE_URL = "https://jnjhkmlvfmynxyjypyie.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuamhrbWx2Zm15bnh5anlweWllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNTA4MjMsImV4cCI6MjA3MzgyNjgyM30.Xp1Y3UvqQhbuxP3KV_1dtW8Zff-yy0fA94G5O3wecOo";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ========== UI / Tabs ========== */
function showTab(id){
  document.getElementById('homePanel').style.display = id==='home' ? 'block':'none';
  // maps tab is always accessible as main area; nothing else to switch visually since map is shown on right
}
showTab('home');

/* ========== MAP Setup ========== */
const map = L.map('map').setView([26.8467,80.9462],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

const busLayer = L.layerGroup().addTo(map);
const roadLayer = L.layerGroup().addTo(map);
let busMarkers = {}; // busId->marker

function toggleLayer(type){
  if(type==='buses') {
    const el = document.getElementById('toggleBuses');
    if(el.checked) map.addLayer(busLayer); else map.removeLayer(busLayer);
  } else {
    const el = document.getElementById('toggleRoads');
    if(el.checked) map.addLayer(roadLayer); else map.removeLayer(roadLayer);
  }
}

/* ========== Static Route Definitions (for demo routing and stops) ========== */
/* We use these to provide 'route geometry' and stops. In a real system these come from DB/GTFS. */
const ROUTES = {
  "R1": {
    name: "TownA → CityB (R1)",
    poly: [[26.8467,80.9462],[26.8500,80.9510],[26.8550,80.9565],[26.8620,80.9630]],
    stops: [
      {id:'R1-S1',name:'TownA Bus Stop',lat:26.8467,lon:80.9462},
      {id:'R1-S2',name:'MidPoint',lat:26.8550,lon:80.9565},
      {id:'R1-S3',name:'CityB Station',lat:26.8620,lon:80.9630}
    ]
  },
  "R2": {
    name: "VillageX → CityB (R2)",
    poly: [[26.8400,80.9400],[26.8450,80.9450],[26.8520,80.9520],[26.8600,80.9590]],
    stops: [
      {id:'R2-S1',name:'VillageX Stop',lat:26.8400,lon:80.9400},
      {id:'R2-S2',name:'Crossing',lat:26.8520,lon:80.9520},
      {id:'R2-S3',name:'CityB Station',lat:26.8600,lon:80.9590}
    ]
  }
};

/* Draw route polylines lightly on map */
Object.values(ROUTES).forEach(r=>{
  L.polyline(r.poly, {color:'#2d7bf6',weight:3,opacity:0.5}).addTo(map);
});

/* ========== Realtime: subscribe to bus_positions inserts ========== */
supabase
  .channel('public:bus_positions')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'bus_positions' }, payload => {
    const b = payload.new;
    upsertBusMarker(b);
  })
  .subscribe();

/* Also fetch last N latest positions on load to populate list */
async function initialLoadPositions(){
  const { data, error } = await supabase
    .from('bus_positions')
    .select('*')
    .order('updated_at', { ascending: false })
    .limit(200);
  if(error) console.error(error);
  if(data) {
    // We'll use the latest position per bus
    const latestByBus = {};
    data.forEach(r => {
      if(!latestByBus[r.bus_id]) latestByBus[r.bus_id]=r;
    });
    Object.values(latestByBus).forEach(upsertBusMarker);
    // also draw road health
    loadRoadHealthOnce();
  }
}
initialLoadPositions();

/* helper: create/update marker */
function upsertBusMarker(b){
  const id = b.bus_id;
  const lat = b.lat; const lon = b.lon;
  const popupHtml = `<b>${id}</b><br>Speed: ${Number(b.speed).toFixed(1)} km/h<br>Heading: ${b.heading}<br><small class="small">${new Date(b.updated_at).toLocaleTimeString()}</small>`;
  if(busMarkers[id]){
    busMarkers[id].setLatLng([lat,lon]);
    busMarkers[id].setPopupContent(popupHtml);
  } else {
    const marker = L.marker([lat,lon], {title:id});
    marker.bindPopup(popupHtml);
    marker.addTo(busLayer);
    busMarkers[id] = marker;
    // attach click to show track modal in left panel summary
    marker.on('click', ()=> {
      showTrackPanel(id);
    });
  }
}

/* ========== Road Health live subscription ========== */
supabase
  .channel('public:road_health')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'road_health' }, payload => {
    addRoadHealthMarker(payload.new);
  })
  .subscribe();

async function loadRoadHealthOnce(){
  const { data, error } = await supabase.from('road_health').select('*').order('updated_at', {ascending:false}).limit(500);
  if(error) console.error(error);
  if(data) data.forEach(addRoadHealthMarker);
}

function addRoadHealthMarker(r){
  // For demo, show small colored circle to denote segment health.
  const c = r.color === 'red' ? '#d9534f' : r.color === 'yellow' ? '#f0ad4e' : '#5cb85c';
  const circle = L.circle([r.lat, r.lon], {radius: 10, fillColor:c, color:c, weight:1, fillOpacity:0.9});
  circle.bindPopup(`<b>Segment ${r.segment_id}</b><br>Score: ${r.score}<br>Samples: ${r.samples_count}<br>${new Date(r.updated_at).toLocaleString()}`);
  circle.addTo(roadLayer);
}

/* ========== HOME SEARCH: find routes by from/to name ========== */
function searchRoutes(){
  const from = (document.getElementById('from').value || '').toLowerCase().trim();
  const to = (document.getElementById('to').value || '').toLowerCase().trim();
  const list = document.getElementById('routesList');
  list.innerHTML = '';
  // naive matching on route stop names
  Object.entries(ROUTES).forEach(([rid, r])=>{
    const stopNames = r.stops.map(s => s.name.toLowerCase());
    const matches = (!from || stopNames.some(n=>n.includes(from))) && (!to || stopNames.some(n=>n.includes(to)));
    if(matches){
      const card = document.createElement('div'); card.className='route-card';
      // compute active buses on this route by checking busMarkers positions within route bbox
      // (simple heuristic: check if any buses are within 1km of any stop)
      const activeBuses = Object.entries(busMarkers).filter(([bid, marker])=>{
        const latlng = marker.getLatLng();
        return r.stops.some(s=>distanceMeters(latlng.lat, latlng.lng, s.lat, s.lon) < 1200);
      }).map(x=>x[0]);

      card.innerHTML = `<b>${r.name}</b><div class="small">Stops: ${r.stops.map(s=>s.name).join(' → ')}</div>
        <div class="small">Active buses: ${activeBuses.length}</div>
        <div style="margin-top:8px">
          <button onclick="listBusesOnRoute('${rid}')">Show buses</button>
          <button onclick="zoomToRoute('${rid}')">Check in Map</button>
        </div>`;
      list.appendChild(card);
    }
  });
  if(list.innerHTML === '') list.innerHTML = '<div class="small">No routes found (try partial village/city names)</div>';
}

/* listBusesOnRoute: show cards for actual buses near the route */
function listBusesOnRoute(routeId){
  const r = ROUTES[routeId];
  const list = document.getElementById('routesList');
  list.innerHTML = `<h4>${r.name} — buses nearby</h4>`;
  const found = Object.entries(busMarkers).filter(([bid, marker])=>{
    const latlng = marker.getLatLng();
    return r.stops.some(s=>distanceMeters(latlng.lat, latlng.lng, s.lat, s.lon) < 1200);
  });

  if(found.length === 0){
    list.innerHTML += '<div class="small">No active buses near this route right now.</div>';
    return;
  }

  found.forEach(([bid, marker])=>{
    const latlng = marker.getLatLng();
    const speed = Math.max(5, (Math.random()*30)+10); // fallback
    // compute next stop and ETA using the route stops
    const nextStopInfo = computeNextStopAndETA(routeId, latlng, speed);
    const card = document.createElement('div'); card.className='route-card';
    card.innerHTML = `<b>${bid}</b><div class="small">Current: ${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)} </div>
      <div class="small">Next stop: ${nextStopInfo.nextStop.name} — ETA ${Math.round(nextStopInfo.etaMinutes)} min</div>
      <div style="margin-top:6px">
        <button onclick="trackBus('${bid}')">Track Bus</button>
        <button onclick="zoomToPoint(${latlng.lat}, ${latlng.lng})">Check in Map</button>
      </div>`;
    list.appendChild(card);
  });
}

/* computeNextStopAndETA: find nearest upcoming stop on route given bus location and approximate speed (km/h) */
function computeNextStopAndETA(routeId, latlng, speedKmph){
  const r = ROUTES[routeId];
  // find the nearest stop that is ahead: naive choose closest stop that is farther than some threshold
  let nearest = null;
  let nearestDist = 1e9;
  r.stops.forEach(s=>{
    const d = distanceMeters(latlng.lat, latlng.lng, s.lat, s.lon);
    if(d < nearestDist){ nearestDist = d; nearest = s; }
  });
  // ETA = distance / speed
  const meters = nearestDist;
  const speedMs = (speedKmph * 1000) / 3600;
  const etaMinutes = speedMs > 0 ? (meters / speedMs) / 60 : 999;
  return { nextStop: nearest, etaMinutes };
}

/* Track bus - center map and open popup and show small route overlay */
function trackBus(busId){
  if(!busMarkers[busId]) return alert("No live marker for " + busId);
  const latlng = busMarkers[busId].getLatLng();
  map.setView(latlng, 15);
  busMarkers[busId].openPopup();
  // Optionally show nearest route polyline
}

/* zoom to route */
function zoomToRoute(routeId){
  const r = ROUTES[routeId];
  const poly = r.poly;
  const bounds = L.latLngBounds(poly);
  map.fitBounds(bounds);
}

/* zoom to point */
function zoomToPoint(lat, lon){
  map.setView([lat, lon], 16);
}

/* ========== Utils ========== */
function distanceMeters(lat1, lon1, lat2, lon2){
  // haversine
  const R = 6371000;
  const toRad = x => x*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

/* ========== Auth / Complaint Flow ========== */
const signupBtn = document.getElementById('signupBtn');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userEmailSpan = document.getElementById('userEmail');

signupBtn.onclick = async () => {
  const email = prompt("Email for sign up:");
  const pass = prompt("Password:");
  if(!email || !pass) return alert("Email + password required");
  const { data, error } = await supabase.auth.signUp({ email, password: pass });
  if(error) alert("Sign up error: " + error.message); else alert("Sign-up started. Confirm via email then login.");
};

loginBtn.onclick = async () => {
  const email = prompt("Email:");
  const pass = prompt("Password:");
  if(!email || !pass) return;
  const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
  if(error) return alert("Login error: " + error.message);
  // show UI
  userSignedIn(data.user);
};

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  userSignedOut();
};

function userSignedIn(user){
  signupBtn.style.display='none';
  loginBtn.style.display='none';
  logoutBtn.style.display='inline-block';
  userEmailSpan.textContent = user.email;
}

function userSignedOut(){
  signupBtn.style.display='inline-block';
  loginBtn.style.display='inline-block';
  logoutBtn.style.display='none';
  userEmailSpan.textContent = '';
}

/* Check session on load */
(async ()=> {
  const { data } = await supabase.auth.getSession();
  if(data.session && data.session.user) userSignedIn(data.session.user);
})();

/* Complaint submission: requires login, geolocation + camera file */
async function submitComplaint(){
  const { data: session } = await supabase.auth.getSession();
  if(!session || !session.session) return alert("Please login to submit a complaint.");
  const user = session.session.user;

  const fileInput = document.getElementById('photoInput');
  if(!fileInput.files || fileInput.files.length === 0) return alert("Please attach a photo (camera).");

  // require geolocation (to ensure photo is geotagged / location validated)
  if(!navigator.geolocation) return alert("Geolocation not supported.");

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    // upload photo to Supabase Storage
    const file = fileInput.files[0];
    const uniqueName = `complaints/${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
    // Ensure you have created a bucket named 'complaints' in Supabase Storage
    const { data: uploadData, error: uploadError } = await supabase.storage.from('complaints').upload(uniqueName, file, { upsert: false });
    if(uploadError){ console.error(uploadError); return alert("Upload error: " + uploadError.message); }
    // Get public URL
    const { data: urlData } = supabase.storage.from('complaints').getPublicUrl(uniqueName);
    // Insert complaint record
    const { error: insertErr } = await supabase.from('complaints').insert([{
      user_id: user.id, lat, lon, photo_path: urlData.publicUrl, message: document.getElementById('complaintMsg').value || ''
    }]);
    if(insertErr) return alert("Insert complaint error: " + insertErr.message);
    document.getElementById('complaintStatus').textContent = "Complaint submitted — thanks!";
    // clear
    fileInput.value = ''; document.getElementById('complaintMsg').value = '';
  }, (err) => {
    alert("Geolocation error: " + err.message + ". Complaint requires location.");
  }, { enableHighAccuracy:true, timeout:10000 });
}

</script>
</body>
</html>
