<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TheRoadApp - Smart Mobility (Perfected)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-main: #121212;
      --bg-panel: #1e1e1e;
      --bg-element: #2a2a2a;
      --border-color: #3a3a3a;
      --text-primary: #f0f0f0;
      --text-secondary: #a0a0a0;
      --accent-primary: #007BFF;
      --accent-primary-hover: #0056b3;
      --accent-danger: #e53935;
      --accent-danger-hover: #b71c1c;
      --border-radius: 12px;
      --font-family: 'Poppins', sans-serif;
    }

    /* --- Base & Layout --- */
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--font-family);
      background: var(--bg-main);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    header {
      display: flex;
      align-items: center;
      padding: 0 24px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    h1.app-title {
      font-size: 1.25rem;
      margin: 0;
      margin-right: 32px;
    }

    .tabs { display: flex; }
    .tab {
      padding: 18px 20px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-secondary);
      border-bottom: 3px solid transparent;
      transition: color 0.3s, border-color 0.3s;
    }
    .tab:hover { color: var(--text-primary); }
    .tab.active {
      color: var(--text-primary);
      border-bottom-color: var(--accent-primary);
    }

    main {
      flex-grow: 1;
      position: relative;
      overflow: hidden;
    }

    .section {
      display: none;
      height: 100%;
      width: 100%;
    }
    .section.active {
      display: flex;
    }

    .content-wrapper {
        display: flex;
        width: 100%;
        height: 100%;
    }

    .panel {
      width: 380px;
      background: var(--bg-panel);
      padding: 24px;
      overflow-y: auto;
      height: 100%;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }
    .panel h2 { margin-top: 0; }
    .panel p.subtitle { color: var(--text-secondary); margin-top: -10px; margin-bottom: 24px; }

    .map-container {
      flex-grow: 1;
      height: 100%;
    }
    #map, #road-health-map {
      width: 100%;
      height: 100%;
      background: var(--bg-element);
    }
    
    /* --- Form Elements --- */
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    .input-field {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-element);
      color: var(--text-primary);
      font-family: var(--font-family);
      font-size: 1rem;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .input-field:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
    }

    .btn {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary {
        background: var(--accent-primary);
        color: white;
    }
    .btn-primary:hover { background: var(--accent-primary-hover); }

    /* --- Bus Results --- */
    #bus-results {
      margin-top: 24px;
      flex-grow: 1;
    }
    #bus-results .empty-state {
        text-align: center;
        color: var(--text-secondary);
        padding: 40px 20px;
        border: 2px dashed var(--border-color);
        border-radius: var(--border-radius);
    }
    .bus-card {
      background: var(--bg-element);
      padding: 16px;
      border-radius: var(--border-radius);
      margin-bottom: 12px;
      border: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s, border-color 0.3s;
    }
    .bus-card:hover { border-color: var(--accent-primary); }
    .bus-card .bus-info { line-height: 1.4; }
    .bus-card .bus-info b { font-size: 1.1rem; }
    .bus-card .bus-info small { color: var(--text-secondary); }
    .bus-card .track-btn {
      background: var(--accent-primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s;
    }
    .bus-card .track-btn:hover { background: var(--accent-primary-hover); }

    /* --- Theme Switcher --- */
    .theme-switcher {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .theme-btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-element);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.3s, color 0.3s;
    }
    .theme-btn:hover { background: var(--accent-primary); color: white; }


    /* --- Floating Action Button (FAB) for Hazard Report --- */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--accent-danger);
      color: white;
      border: none;
      font-size: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: background 0.3s, transform 0.2s ease-out;
      z-index: 999;
    }
    .fab:hover {
      background: var(--accent-danger-hover);
      transform: scale(1.05);
    }
    .fab:active { transform: scale(0.95); }

    /* --- Modal --- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .modal-overlay.visible {
      display: flex;
      opacity: 1;
    }
    .modal {
      background: var(--bg-panel);
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      border: 1px solid var(--border-color);
      transform: scale(0.95);
      transition: transform 0.3s;
    }
    .modal-overlay.visible .modal { transform: scale(1); }
    .modal h3 { margin-top: 0; margin-bottom: 24px; }
    .modal .form-group { margin-bottom: 20px; }
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }
    .modal-actions .btn { width: auto; padding: 10px 20px; }
    .btn-secondary { background: var(--bg-element); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background: var(--border-color); }

    /* Custom file input */
    input[type="file"] { display: none; }
    .file-input-label {
      background-color: var(--bg-element);
      color: var(--text-secondary);
      border: 1px dashed var(--border-color);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .file-input-label:hover {
      background-color: var(--border-color);
      border-color: var(--accent-primary);
    }
    #file-name {
      margin-top: 10px;
      font-size: 0.9em;
      color: var(--text-primary);
    }


    /* --- Loading Spinner --- */
    .loader {
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--accent-primary);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* --- Responsive Design --- */
    @media (max-width: 800px) {
      .content-wrapper { flex-direction: column; }
      .panel {
        width: 100%;
        height: auto;
        max-height: 45vh; /* Panel takes up max 45% of viewport height */
        border-bottom: 1px solid var(--border-color);
      }
      .map-container { height: auto; flex-grow: 1; }
      header { padding: 0 16px; }
      h1.app-title { font-size: 1.1rem; margin-right: 16px; }
      .tab { padding: 16px 12px; font-size: 0.9rem; }
      .fab { bottom: 16px; right: 16px; }
    }
  </style>
</head>
<body>

<header>
  <h1 class="app-title">üöç TheRoadApp</h1>
  <nav class="tabs">
    <div class="tab active" data-target="home-section">Home</div>
    <div class="tab" data-target="road-health-section">Road Health</div>
  </nav>
</header>

<main>
  <div id="home-section" class="section active">
    <div class="content-wrapper">
      <div class="panel">
        <h2>Find Your Bus</h2>
        <p class="subtitle">Search for your route and track buses in real-time.</p>
        <div class="form-group">
          <input type="text" id="departure" class="input-field" placeholder="Enter Departure Location">
        </div>
        <div class="form-group">
          <input type="text" id="arrival" class="input-field" placeholder="Enter Arrival Location">
        </div>
        <button id="search-bus-btn" class="btn btn-primary">
          <span>üîç Search Buses</span>
        </button>
        <div id="bus-results">
            <div class="empty-state">Your search results will appear here.</div>
        </div>
        <div class="theme-switcher">
          <div class="theme-btn" data-theme="osm">OSM</div>
          <div class="theme-btn" data-theme="sat">Satellite</div>
          <div class="theme-btn" data-theme="dark">Dark</div>
          <div class="theme-btn" data-theme="topo">Topographic</div>
        </div>
      </div>
      <div class="map-container">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <div id="road-health-section" class="section">
    <div class="content-wrapper">
        <div class="panel">
            <h2>üõ£Ô∏è Road Health</h2>
            <p class="subtitle">Check road conditions before you travel.</p>
            <div class="form-group">
              <input type="text" id="road-from" class="input-field" placeholder="Enter Start Location">
            </div>
            <div class="form-group">
              <input type="text" id="road-to" class="input-field" placeholder="Enter Destination">
            </div>
            <button id="road-health-btn" class="btn btn-primary">Check Road Condition</button>
             <div class="theme-switcher">
              <div class="theme-btn" data-theme="osm-road">OSM</div>
              <div class="theme-btn" data-theme="sat-road">Satellite</div>
              <div class="theme-btn" data-theme="dark-road">Dark</div>
            </div>
        </div>
        <div class="map-container">
            <div id="road-health-map"></div>
        </div>
    </div>
  </div>
</main>

<button id="report-hazard-btn" class="fab" title="Report Hazard">+</button>

<div id="modal" class="modal-overlay">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Report a Hazard</h3>
    <div class="form-group">
      <label for="hazard-type">Type of hazard</label>
      <select id="hazard-type" class="input-field">
        <option value="pothole">Pothole</option>
        <option value="obstruction">Obstruction (fallen tree, debris)</option>
        <option value="water_logging">Water logging / Flood</option>
        <option value="accident">Accident</option>
        <option value="other">Other</option>
      </select>
    </div>
    <div class="form-group">
      <label for="hazard-desc">Description</label>
      <textarea id="hazard-desc" class="input-field" rows="3" placeholder="Describe the hazard..."></textarea>
    </div>
    <div class="form-group">
      <label for="hazard-photo">Photo (optional)</label>
      <label for="hazard-photo" class="file-input-label">
        <span>Click to upload image</span>
        <div id="file-name"></div>
      </label>
      <input id="hazard-photo" type="file" accept="image/*" capture="environment">
    </div>
    <div class="form-group">
      <label>Detected Location</label>
      <input type="text" id="hazard-loc" class="input-field" readonly>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="cancel-modal">Cancel</button>
      <button class="btn btn-primary" id="submit-hazard">Submit</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

  const SUPABASE_URL = "https://jnjhkmlvfmynxyjypyie.supabase.co";
  const SUPABASE_KEY = "YOUR_SUPABASE_KEY"; // replace with your key
  const POLL = 3000;

  let map, busLayer, busMarkers = {}, selectedBus = null, busPollId = null;
  let roadMap, roadLayerGroup;
  let baseLayers = {}, currentBaseLayer;

  // --- Initializers ---
  function initHomeMap() {
    if (map) return;
    map = L.map("map").setView([20.5937, 78.9629], 5); // Center on India

    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 });
    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 });
    const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png');

    baseLayers = { "OpenStreetMap": osm, "Satellite": esriSat, "Dark": cartoDark, "Topographic": topo };
    cartoDark.addTo(map); // Default to dark theme to match UI
    currentBaseLayer = cartoDark;

    busLayer = L.layerGroup().addTo(map);
  }

  function initRoadMap() {
    if (roadMap) return;
    roadMap = L.map('road-health-map').setView([20.5937, 78.9629], 5);
    const darkRoad = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
    darkRoad.addTo(roadMap);
    roadLayerGroup = L.layerGroup().addTo(roadMap);
  }
  
  // Initialize home map on load as it's visible by default
  initHomeMap();

  // --- Tab Switcher ---
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      tab.classList.add("active");
      const target = document.getElementById(tab.dataset.target);
      target.classList.add("active");

      if (tab.dataset.target === 'road-health-section') {
        initRoadMap();
        setTimeout(() => { roadMap.invalidateSize(); }, 10);
      } else {
        setTimeout(() => { if (map) map.invalidateSize(); }, 10);
      }
    });
  });

  const busIcon = L.icon({
      iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiIHdpZHRoPSIzNnB4IiBoZWlnaHQ9IjM2cHgiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiLz48cGF—ÇaCBkPSJNNC4wMSA2LjAzQzIuNzkgNi41MyAyIDEuODIgMiAzLjUgMiA1LjQzIDMuNTcgNyA1LjUgN2gzLjV2LTJIMFY0YzAtMS4xMS44OS0yIDItMmgxNmMxLjExIDAgMiAuODkgMiAydjEwLjVjMCAxLjY1LTEuMzUgMy0zIDNoLS41di0ySDIwbC0xLjY3LTUtMS4zMyA0SDE0Yy0xLjExIDAtMi0uODktMi0yVjdoLTR2NmgtMS40MWMtLjQ5IDAtLjkzLS4yNy0xLjE2LS42OUw0LjAxIDYuMDN6TTggNGgydjFIOFY0em0xMCAwdiFoMmwtMi0xem0tMS41IDhBMS41IDEuNSAwIDAgMCAxOCAxMC41IDEuNSAxLjUgMCAwIDAgMTYuNSAxMlMxNSAxMy41IDE2LjUgMTQuNSAxOCAxMy41IDE4IDEyVjloLTNDNC41IDkgNCAxMC41IDQgMTJzMS41IDMgMyAzIDMtMS41IDMtMy0xLjUtMy0zLTN6bS0xMS41IDFDNS4yMiAxMyA1IDEzLjc4IDUgMTQuNVM1LjIyIDE2IDUgMTZzMS4yMiAxIDEuNSAxIDEuNS0uMjIgMS41LS41UzcuNzggMTMgNi41IDEzIDUgMTMgNSAxM3ptMTEgMGMtMS4yOCAwLTIuNSAxLjIyLTIuNSAxLjVzMS4yMi41IDIuNS41IDIuNS0uMjIgMi41LS41LTEuMjItMS41LTIuNS0xLjV6Ii8+PC9zdmc+',
      iconSize: [36, 36],
      iconAnchor: [18, 18],
      popupAnchor: [0, -18],
      className: 'bus-marker' // Used for potential future styling
  });


  async function loadBuses() {
    if (!map) return;
    const url = `${SUPABASE_URL}/rest/v1/bus_location?select=*&order=ts.desc&limit=200`;
    try {
      const res = await fetch(url, { headers: { apikey: SUPABASE_KEY, Authorization: "Bearer " + SUPABASE_KEY } });
      const rows = await res.json();
      const latest = {};
      rows.forEach(r => { if (!latest[r.device_id]) latest[r.device_id] = r; });

      Object.keys(busMarkers).forEach(id => { if (!latest[id]) { busLayer.removeLayer(busMarkers[id]); delete busMarkers[id]; } });

      for (const r of Object.values(latest)) {
        if (!r.lat || !r.lon) continue;
        const pos = [r.lat, r.lon];
        const popupContent = `<b>Bus ID:</b> ${r.device_id}<br><b>Last updated:</b> ${new Date(r.ts).toLocaleTimeString()}`;

        if (busMarkers[r.device_id]) {
          busMarkers[r.device_id].setLatLng(pos);
          busMarkers[r.device_id].setPopupContent(popupContent);
        } else {
          const marker = L.marker(pos, { icon: busIcon }).bindPopup(popupContent);
          marker.addTo(busLayer);
          busMarkers[r.device_id] = marker;
        }
      }

      if (selectedBus && busMarkers[selectedBus]) {
        map.setView(busMarkers[selectedBus].getLatLng(), 15, { animate: true });
        busMarkers[selectedBus].openPopup();
      }
    } catch (e) { console.error("Bus load failed:", e); }
  }

  document.getElementById("search-bus-btn").addEventListener("click", () => {
    const from = document.getElementById("departure").value.trim() || 'Departure';
    const to = document.getElementById("arrival").value.trim() || 'Arrival';
    const resultsDiv = document.getElementById("bus-results");
    const searchBtn = document.getElementById("search-bus-btn");
    
    resultsDiv.innerHTML = '<div class="loader-container" style="display:flex; justify-content:center; padding:40px;"><div class="loader"></div></div>';
    searchBtn.disabled = true;

    // Mock results (replace with Supabase filtering by route)
    setTimeout(() => {
        resultsDiv.innerHTML = ""; // Clear loader
        const mockBuses = [{ id: "bus101", route: `${from} ‚Üí ${to}` }, { id: "bus202", route: `${from} ‚Üí ${to}` }];
        
        if(mockBuses.length === 0) {
            resultsDiv.innerHTML = '<div class="empty-state">No buses found for this route.</div>';
        } else {
            mockBuses.forEach(bus => {
              const div = document.createElement("div");
              div.className = "bus-card";
              div.innerHTML = `<div class="bus-info"><b>${bus.id}</b><br><small>${bus.route}</small></div>
                             <button class="track-btn" data-bus="${bus.id}">Track</button>`;
              resultsDiv.appendChild(div);
            });
        }
        
        document.querySelectorAll('.track-btn').forEach(btn => btn.addEventListener('click', () => {
          trackBus(btn.dataset.bus);
        }));
        searchBtn.disabled = false;
    }, 1500); // Simulate network delay
  });

  function trackBus(busId) {
    selectedBus = busId;
    if (busPollId) clearInterval(busPollId);
    loadBuses();
    busPollId = setInterval(loadBuses, POLL);
    if (busMarkers[selectedBus]) {
      map.setView(busMarkers[selectedBus].getLatLng(), 15);
    }
  }
  
  // --- Theme Switching ---
  document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const t = btn.dataset.theme;
      // Homepage map themes
      if (['osm', 'sat', 'dark', 'topo'].includes(t)) {
        if (!map) initHomeMap();
        if (currentBaseLayer) map.removeLayer(currentBaseLayer);
        const chosen = { 'osm': 'OpenStreetMap', 'sat': 'Satellite', 'dark': 'Dark', 'topo': 'Topographic' }[t];
        currentBaseLayer = baseLayers[chosen];
        if (currentBaseLayer) currentBaseLayer.addTo(map);
      }
      // Road map themes
      if (['osm-road', 'sat-road', 'dark-road'].includes(t)) {
        if (!roadMap) initRoadMap();
        const mapping = {
          'osm-road': "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          'sat-road': 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
          'dark-road': 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
        };
        roadMap.eachLayer(layer => { if (layer instanceof L.TileLayer) roadMap.removeLayer(layer); });
        L.tileLayer(mapping[t]).addTo(roadMap);
      }
    });
  });

  // --- Road Health ---
  document.getElementById('road-health-btn').addEventListener('click', async () => {
    if (!roadMap) initRoadMap();
    roadLayerGroup.clearLayers();
    // Add loader to map
    const roadCheckBtn = document.getElementById('road-health-btn');
    roadCheckBtn.innerHTML = '<div class="loader"></div>';
    roadCheckBtn.disabled = true;

    const url = `${SUPABASE_URL}/rest/v1/road_health?select=*`;
    try {
      const res = await fetch(url, { headers: { apikey: SUPABASE_KEY, Authorization: 'Bearer ' + SUPABASE_KEY } });
      const rows = await res.json();
      rows.forEach(r => {
        if (!r.lat || !r.lon) return;
        let color = '#4caf50'; // green
        if (r.condition === 'bad') color = '#f44336'; // red
        else if (r.condition === 'medium') color = '#ff9800'; // orange
        L.circleMarker([r.lat, r.lon], { radius: 8, color: 'white', weight: 2, fillColor: color, fillOpacity: 0.9 })
          .addTo(roadLayerGroup).bindPopup(`<b>Road Condition:</b> ${r.condition}`);
      });
      if (roadLayerGroup.getLayers().length > 0) {
        roadMap.fitBounds(roadLayerGroup.getBounds(), { padding: [50, 50] });
      }
    } catch (e) { console.error('Road health load failed:', e); }
    finally {
        roadCheckBtn.innerHTML = 'Check Road Condition';
        roadCheckBtn.disabled = false;
    }
  });

  // --- Hazard Report Modal Flow ---
  const modal = document.getElementById('modal');
  const reportBtn = document.getElementById('report-hazard-btn');
  const cancelModalBtn = document.getElementById('cancel-modal');
  const submitHazardBtn = document.getElementById('submit-hazard');
  const hazardLocInput = document.getElementById('hazard-loc');
  let currentLat = null, currentLon = null;

  reportBtn.addEventListener('click', () => {
    modal.classList.add('visible');
    hazardLocInput.value = 'Detecting location...';
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((pos) => {
        currentLat = pos.coords.latitude;
        currentLon = pos.coords.longitude;
        hazardLocInput.value = `${currentLat.toFixed(6)}, ${currentLon.toFixed(6)}`;
      }, (err) => {
        console.warn('Geolocation error:', err);
        hazardLocInput.value = 'Could not get location.';
      }, { enableHighAccuracy: true, timeout: 8000 });
    } else {
      hazardLocInput.value = 'Geolocation not supported.';
    }
  });
  
  const closeModal = () => {
    modal.classList.remove('visible');
    // Reset form
    document.getElementById('hazard-desc').value = '';
    document.getElementById('hazard-photo').value = null;
    document.getElementById('file-name').textContent = '';
  };
  cancelModalBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); }); // Close on overlay click

  // Custom file input display
  document.getElementById('hazard-photo').addEventListener('change', function() {
    document.getElementById('file-name').textContent = this.files[0] ? this.files[0].name : '';
  });

  const fileToBase64 = (file) => new Promise((resolve, reject) => {
      if (!file) return resolve(null);
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
      reader.readAsDataURL(file);
  });

  submitHazardBtn.addEventListener('click', async () => {
    const type = document.getElementById('hazard-type').value;
    const desc = document.getElementById('hazard-desc').value;
    const file = document.getElementById('hazard-photo').files[0];

    if(!currentLat || !currentLon) {
        alert('Location is required to report a hazard.');
        return;
    }

    submitHazardBtn.disabled = true;
    submitHazardBtn.innerHTML = '<div class="loader"></div>';

    try {
      const photoData = await fileToBase64(file);
      const payload = { type, description: desc, lat: currentLat, lon: currentLon, photo_data: photoData, created_at: new Date().toISOString() };
      const url = `${SUPABASE_URL}/rest/v1/hazards`;
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', apikey: SUPABASE_KEY, Authorization: 'Bearer ' + SUPABASE_KEY },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(await res.text());
      
      alert('Hazard reported successfully. Thank you for your contribution!');
      closeModal();
    } catch (e) {
      console.error('Hazard submit failed:', e);
      alert('Failed to submit hazard. Please try again.');
    } finally {
      submitHazardBtn.disabled = false;
      submitHazardBtn.textContent = 'Submit';
    }
  });
});
</script>
</body>
</html>
