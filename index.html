<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>TheRoadApp - Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family:sans-serif; background:#111; color:#eee; }
    #map { height:80vh; }
    button { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; }
    #hazard-form { margin:10px; background:#222; padding:10px; border-radius:8px; }
  </style>
</head>
<body>
  <h2 style="margin:10px">üöç TheRoadApp Viewer</h2>
  <div id="map"></div>
  <div id="hazard-form">
    <h3>‚ö†Ô∏è Report Hazard</h3>
    <select id="hazard-type">
      <option value="pothole">Pothole</option>
      <option value="obstruction">Obstruction</option>
      <option value="flood">Water logging</option>
      <option value="accident">Accident</option>
    </select><br><br>
    <textarea id="hazard-desc" placeholder="Description..." rows="2" style="width:100%"></textarea><br><br>
    <button id="report">Submit</button>
  </div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const SUPABASE_URL = "https://jnjhkmlvfmynxyjypyie.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuamhrbWx2Zm15bnh5anlweWllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNTA4MjMsImV4cCI6MjA3MzgyNjgyM30.Xp1Y3UvqQhbuxP3KV_1dtW8Zff-yy0fA94G5O3wecOo"; // ‚ö†Ô∏è Replace with your anon key

let map = L.map("map").setView([20,0], 3);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

const busLayer = L.layerGroup().addTo(map);
const roadLayer = L.layerGroup().addTo(map);
const hazardLayer = L.layerGroup().addTo(map);

const busIcon = L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/61/61212.png",iconSize:[32,32],iconAnchor:[16,16]});

// --- Load buses ---
async function loadBuses(){
  const url = `${SUPABASE_URL}/rest/v1/bus_location?select=*&order=ts.desc&limit=200`;
  const res = await fetch(url,{headers:{apikey:SUPABASE_KEY,Authorization:"Bearer "+SUPABASE_KEY}});
  const rows = await res.json();
  busLayer.clearLayers();
  const latest={};
  rows.forEach(r=>{ if(!latest[r.device_id]) latest[r.device_id]=r; });
  Object.values(latest).forEach(r=>{
    if(r.lat && r.lon){
      L.marker([r.lat,r.lon],{icon:busIcon}).addTo(busLayer)
        .bindPopup(`Bus ${r.device_id}<br>${new Date(r.ts).toLocaleTimeString()}`);
    }
  });
}

// --- Load road health ---
async function loadRoadHealth(){
  const url = `${SUPABASE_URL}/rest/v1/road_health?select=*`;
  const res = await fetch(url,{headers:{apikey:SUPABASE_KEY,Authorization:"Bearer "+SUPABASE_KEY}});
  const rows = await res.json();
  roadLayer.clearLayers();
  rows.forEach(r=>{
    let color = r.score==='bad'?'red': r.score==='medium'?'orange':'green';
    L.polyline([[r.lat_start,r.lon_start],[r.lat_end,r.lon_end]],{color:color}).addTo(roadLayer)
      .bindPopup(`Road: ${r.score}`);
  });
}

// --- Load hazards ---
async function loadHazards(){
  const url = `${SUPABASE_URL}/rest/v1/hazards?select=*`;
  const res = await fetch(url,{headers:{apikey:SUPABASE_KEY,Authorization:"Bearer "+SUPABASE_KEY}});
  const rows = await res.json();
  hazardLayer.clearLayers();
  rows.forEach(r=>{
    if(r.lat && r.lon){
      L.circleMarker([r.lat,r.lon],{radius:6,color:"yellow"}).addTo(hazardLayer)
        .bindPopup(`‚ö†Ô∏è ${r.type}<br>${r.description||""}`);
    }
  });
}

// --- Submit hazard ---
document.getElementById("report").onclick = async ()=>{
  if(!navigator.geolocation) return alert("No GPS available");
  navigator.geolocation.getCurrentPosition(async pos=>{
    const payload = {
      type: document.getElementById("hazard-type").value,
      description: document.getElementById("hazard-desc").value,
      lat: pos.coords.latitude,
      lon: pos.coords.longitude,
      created_at: new Date().toISOString()
    };
    const res = await fetch(`${SUPABASE_URL}/rest/v1/hazards`,{
      method:"POST",
      headers:{apikey:SUPABASE_KEY,Authorization:"Bearer "+SUPABASE_KEY,"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    if(res.ok){
      alert("‚úÖ Hazard submitted");
      document.getElementById("hazard-desc").value="";
      loadHazards();
    } else {
      alert("‚ùå Error submitting hazard");
    }
  });
};

// Refresh data every 5s
loadBuses(); loadRoadHealth(); loadHazards();
setInterval(loadBuses,5000);
setInterval(loadRoadHealth,10000);
setInterval(loadHazards,10000);
</script>
</body>
</html>
