<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Commuter App - TheRoadApp</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { font-family: sans-serif; margin:0; background:#121212; color:#f5f5f5; }
    h1 { padding:12px; }
    #map { height:70vh; margin:10px; border-radius:10px; }
    button { margin:10px; padding:12px; border:none; border-radius:8px; background:#007BFF; color:#fff; font-weight:bold; }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; }
    .modal { background:#1e1e1e; padding:20px; border-radius:10px; width:90%; max-width:400px; }
    .form-group { margin-bottom:12px; }
    input, select, textarea { width:100%; padding:10px; border-radius:6px; border:1px solid #333; background:#2a2a2a; color:#fff; }
  </style>
</head>
<body>
  <h1>üõ£Ô∏è TheRoadApp</h1>
  <button id="report">Report Hazard</button>
  <div id="map"></div>

  <!-- Modal -->
  <div id="modal" class="modal-overlay">
    <div class="modal">
      <h3>Report Hazard</h3>
      <div class="form-group">
        <label>Type</label>
        <select id="hazard-type">
          <option value="pothole">Pothole</option>
          <option value="obstruction">Obstruction</option>
          <option value="water_logging">Water logging</option>
          <option value="accident">Accident</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="hazard-desc"></textarea>
      </div>
      <div class="form-group">
        <label>Location</label>
        <input id="hazard-loc" readonly>
      </div>
      <button id="submit">Submit</button>
      <button id="cancel">Cancel</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script type="module">
    // === Supabase Config ===
    const SUPABASE_URL = "https://jnjhkmlvfmynxyjypyie.supabase.co";
    const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuamhrbWx2Zm15bnh5anlweWllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNTA4MjMsImV4cCI6MjA3MzgyNjgyM30.Xp1Y3UvqQhbuxP3KV_1dtW8Zff-yy0fA94G5O3wecOo";

    // Init map
    const map = L.map("map").setView([20,77], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

    // Modal controls
    const modal=document.getElementById("modal");
    document.getElementById("report").onclick=()=>{
      modal.style.display="flex";
      navigator.geolocation.getCurrentPosition(pos=>{
        document.getElementById("hazard-loc").value =
          `${pos.coords.latitude}, ${pos.coords.longitude}`;
      });
    };
    document.getElementById("cancel").onclick=()=>modal.style.display="none";

    // Submit hazard
    document.getElementById("submit").onclick=async()=>{
      const loc=document.getElementById("hazard-loc").value.split(",");
      const payload={
        type:document.getElementById("hazard-type").value,
        description:document.getElementById("hazard-desc").value,
        latitude:parseFloat(loc[0]),
        longitude:parseFloat(loc[1]),
        reported_at:new Date().toISOString()
      };

      try{
        const res=await fetch(`${SUPABASE_URL}/rest/v1/hazards`,{
          method:"POST",
          headers:{
            apikey:API_KEY,
            Authorization:`Bearer ${API_KEY}`,
            "Content-Type":"application/json",
            Prefer:"return=minimal"
          },
          body:JSON.stringify(payload)
        });
        if(res.ok){
          alert("‚úÖ Hazard reported!");
          modal.style.display="none";
          // add marker
          L.marker([payload.latitude,payload.longitude]).addTo(map)
            .bindPopup(`${payload.type}: ${payload.description}`);
        } else {
          alert("‚ùå Failed: "+await res.text());
        }
      }catch(e){ alert("Error: "+e.message); }
    };

    // Load existing hazards
    async function loadHazards(){
      const res=await fetch(`${SUPABASE_URL}/rest/v1/hazards?select=*`,{
        headers:{ apikey:API_KEY, Authorization:`Bearer ${API_KEY}` }
      });
      const hazards=await res.json();
      hazards.forEach(h=>{
        L.marker([h.latitude,h.longitude]).addTo(map)
          .bindPopup(`${h.type}: ${h.description}`);
      });
    }
    loadHazards();
  </script>
</body>
</html>
